# Makefile for Applications using the Oscar Framework
# Copyright (C) 2008 Supercomputing Systems AG
# 
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty. This file is offered as-is,
# without any warranty.

# Disable make's built-in rules.
MAKE += -RL --no-print-directory
SHELL := $(shell which bash)

# Include the file generated by te configuration process.
-include .config oscar/.config
ifeq '$(filter .config, $(MAKEFILE_LIST))' ''
$(error Please configure the application using './configure' prior to compilation.)
endif

##--------------------------------------------------------------------------
#  Application specific part
##--------------------------------------------------------------------------

# Name for the application to produce.
APP_NAME := web_view_cpp

# Name of the directory the application should be deployed to on the target.
DEPLOY_DIR := /mnt/app/

# Binary executables to generate (make sure it's the same as in the run.sh script).
PRODUCTS := app
# subproduct folders: for each folder, make will be called
SUB_PRODUCTS := cgi

# Listings of source files for the different executables.
SOURCES_app := $(wildcard *.cpp) $(wildcard *.c)

# Listings of source files for the different applications.
SOURCES_$(APP_NAME) := $(wildcard *.cpp) $(wildcard *.c)

# statically linked libraries
LIBS_host := oscar/library/libosc_host
LIBS_target := oscar/library/libosc_target

##--------------------------------------------------------------------------
#  Common part
##--------------------------------------------------------------------------

# Generic flags for the C/CPP compiler.
CFLAGS := -c -Wall -Ioscar/include

ifeq '$(CONFIG_USE_OPENCV)' 'y'
-include MakeOpenCV.mk
else
OPENCV_INC_host :=
OPENCV_LIBS_host := 
OPENCV_INC_target :=
OPENCV_LIBS_target := 
endif

#Oscar CC
ifeq '$(CONFIG_USE_OSCAR_CC)' 'y'

IS_ABSOLUTE_PATH := $(shell expr "$(CONFIG_FRAMEWORK_PATH)" : '/')
ifeq '$(IS_ABSOLUTE_PATH)' '0'
ABS_OSCAR_PATH := $(shell pwd)/$(CONFIG_FRAMEWORK_PATH)
else
ABS_OSCAR_PATH := $(CONFIG_FRAMEWORK_PATH)
endif

-include $(CONFIG_OSCAR_CC_PATH)/.config
#M_INC := -I$(CONFIG_OSCAR_CC_PATH)/modules/$mod/include
CFLAGS += $(addsuffix /include, $(addprefix -I$(CONFIG_OSCAR_CC_PATH)/modules/, $(CONFIG_CC_MODULES)))
OSC_CC_LIBS_host := $(addsuffix _host, $(addprefix -losc-cc_, $(CONFIG_CC_MODULES)))
OSC_CC_LIBS_target := $(addsuffix _target, $(addprefix -losc-cc_, $(CONFIG_CC_MODULES)))
OSC_CC_LIBS_INC := -L$(CONFIG_OSCAR_CC_PATH)/library
else
OSC_CC_LIBS_host := 
OSC_CC_LIBS_target := 
OSC_CC_LIBS_INC := 
endif # '$(CONFIG_USE_OSCAR_CC)' 'y'



ifeq '$(CONFIG_USE_GPP_COMPILER)' 'y'
GCC := g++
else
CFLAGS += -std=gnu99
GCC := gcc
endif

CC_host := $(GCC) $(CFLAGS) $(OPENCV_INC_host) -DOSC_HOST -D'APP_NAME="$(APP_NAME)"'
LD_host := $(GCC) -fPIC

ifeq '$(CONFIG_BOARD)' 'raspi-cam'
 CC_target := arm-linux-gnueabihf-$(GCC) $(CFLAGS) $(OPENCV_INC_target) -DOSC_HOST -D'APP_NAME="$(APP_NAME)"'
 LD_target := arm-linux-gnueabihf-$(GCC) -fPIC
else
 CC_target := bfin-uclinux-$(GCC) $(CFLAGS) $(OPENCV_INC_target) -DOSC_TARGET -D'APP_NAME="$(APP_NAME)"'
 LD_target := bfin-uclinux-$(GCC) -elf2flt="-s 1048576"
endif

ifeq '$(CONFIG_ENABLE_DEBUG)' 'y'
CC_host +=  -g
CC_target +=  -ggdb3
else
CC_host +=  -O2
CC_target +=  -O2
endif
ifeq '$(CONFIG_ENABLE_SIMULATION)' 'y'
CC_host += -DOSC_SIM
CC_target += -DOSC_SIM
endif

ifeq '$(CONFIG_PRIVATE_FRAMEWORK)' 'y'
CONFIG_FRAMEWORK_PATH := ./oscar
endif

APPS := $(patsubst SOURCES_%, %, $(filter SOURCES_%, $(.VARIABLES)))

ifeq '$(CONFIG_ENABLE_SIMULATION)' 'y'
LIBS_target := $(LIBS_target)_sim
endif
ifeq '$(CONFIG_ENABLE_DEBUG)' 'y'
LIBS_host := $(addsuffix _dbg, $(LIBS_host))
LIBS_target := $(addsuffix _dbg, $(LIBS_target))
OSC_CC_LIBS_host := $(addsuffix _dbg, $(OSC_CC_LIBS_host))
OSC_CC_LIBS_target := $(addsuffix _dbg, $(OSC_CC_LIBS_target))
endif
LIBS_host := $(addsuffix .a, $(LIBS_host))
LIBS_target := $(addsuffix .a, $(LIBS_target))


ifeq '$(CONFIG_BOARD)' 'raspi-cam'
 LIBS_target := $(LIBS_target)
 else
 LIBS_target := $(LIBS_target) -lm -lbfdsp
endif
        

BINARIES := $(addsuffix _host, $(PRODUCTS)) $(addsuffix _target, $(PRODUCTS))

.PHONY: all clean host target install deploy run reconfigure opencv oscar
all: $(BINARIES)
	$(foreach i, $(SUB_PRODUCTS), make -C $i CONFIG_BOARD=$(CONFIG_BOARD) APP_NAME=$(APP_NAME) PRODUCT=$i)
host target: %: $(addsuffix _%, $(PRODUCTS))

opencv:
ifeq '$(CONFIG_USE_OPENCV)' 'y'
	cd $(CONFIG_OPENCV_PATH) && ./do-build
endif

deploy: $(APP_NAME).app
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	tar c $< | ssh ebv 'rm -rf $< && tar x > /dev/null 2>&1' || true
else	
	tar c $< | ssh root@$(CONFIG_TARGET_IP) 'rm -rf $< && tar x -C $(DEPLOY_DIR)' || true
endif

# lfe tar c $< | ssh pi@$(CONFIG_TARGET_IP) 'rm -rf $< && tar x > /dev/null 2>&1' || true

run:
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	ssh ebv /home/pi/$(APP_NAME).app/run.sh || true
else
	ssh root@$(CONFIG_TARGET_IP) $(DEPLOY_DIR)$(APP_NAME).app/run.sh || true
endif
# lfe ssh pi@$(CONFIG_TARGET_IP) /home/pi/$(APP_NAME).app/run.sh || true

rundbg:
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	ssh ebv 'killall app;  gdbserver localhost:8888 /home/pi/$(APP_NAME).app/app' || true
else
	ssh root@$(CONFIG_TARGET_IP) $(DEPLOY_DIR)$(APP_NAME).app/run.sh || true
endif
# lfe ssh pi@$(CONFIG_TARGET_IP) 'killall app;  gdbserver localhost:8888 /home/pi/$(APP_NAME).app/app' || true

dad: $(APP_NAME).app
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	tar c $< | ssh ebv 'rm -rf $< && tar x > /dev/null 2>&1' || true
	ssh ebv 'killall app;  gdbserver localhost:8888 /home/pi/$(APP_NAME).app/app' || true
else	
	tar c $< | ssh root@$(CONFIG_TARGET_IP) 'rm -rf $< && tar x -C $(DEPLOY_DIR)' || true
	ssh root@$(CONFIG_TARGET_IP) $(DEPLOY_DIR)$(APP_NAME).app/run.sh || true
endif

dar: $(APP_NAME).app
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	tar c $< | ssh ebv 'rm -rf $< && tar x > /dev/null 2>&1' || true
	ssh ebv /home/pi/$(APP_NAME).app/run.sh || true
else	
	tar c $< | ssh root@$(CONFIG_TARGET_IP) 'rm -rf $< && tar x -C $(DEPLOY_DIR)' || true
	ssh root@$(CONFIG_TARGET_IP) $(DEPLOY_DIR)$(APP_NAME).app/run.sh || true
endif

settime:
ifeq '$(CONFIG_BOARD)' 'raspi-cam'
	ssh ebv sudo date -s @`( date -u +"%s" )`
endif   
# lfe ssh pi@192.168.1.10 sudo date -s @`( date -u +"%s" )`
                        

install: cgi/cgi_host
#install only if folder exists
ifneq "$(wildcard www )" ""
	cp -RL www/* /var/www
	cp $< /var/www/cgi-bin/cgi
	chmod -Rf a+rX /var/www/ || true
endif

reconfigure:
ifeq '$(CONFIG_USE_OSCAR_CC)' 'y'
	cd $(CONFIG_OSCAR_CC_PATH) && ./configure CONFIG_CC_PRIVATE_FRAMEWORK=n CONFIG_CC_FRAMEWORK_PATH='$(ABS_OSCAR_PATH)'
endif

ifeq '$(CONFIG_PRIVATE_FRAMEWORK)' 'n'
	@ ! [ -e "oscar" ] || [ -h "oscar" ] && ln -sfn $(CONFIG_FRAMEWORK_PATH) oscar || echo "The symlink to the oscar module could not be created."
endif
	@ ! [ -d "oscar" ] || $(MAKE) -C oscar config

ifeq '$(CONFIG_USE_OPENCV)' 'y'
	@ ! [ -e "opencv" ] || [ -h "opencv" ] && ln -sfn $(CONFIG_OPENCV_PATH)/OpenCV4.1.1 opencv || echo "The symlink to the opencv module could not be created."
endif
	
oscar:
	$(MAKE) -C oscar
oscar/%:
	$(MAKE) -C oscar $*
osc-cc:
ifeq '$(CONFIG_USE_OSCAR_CC)' 'y'
	$(MAKE) -C $(CONFIG_OSCAR_CC_PATH) $*
endif

# Including depency files and optional local Makefile.
-include build/*.d

# Build targets.
build/%_host.o: $(filter-out %.d, $(MAKEFILE_LIST))
	@ mkdir -p $(dir $@)
	$(CC_host) -MD $(filter $*.c $*.cpp,$($(addsuffix $(PRODUCTS), SOURCES_))) -o $@
	@ grep -oE '[^ \\]+' < $(@:.o=.d) | sed -r '/:$$/d; s|^.*$$|$@: \0\n\0:|' > $(@:.o=.d~) && mv -f $(@:.o=.d){~,}
build/%_target.o: $(filter-out %.d, $(MAKEFILE_LIST))
	@ mkdir -p $(dir $@)
	$(CC_target) -MD $(filter $*.c $*.cpp,$($(addsuffix $(PRODUCTS), SOURCES_))) -o $@
	@ grep -oE '[^ \\]+' < $(@:.o=.d) | sed -r '/:$$/d; s|^.*$$|$@: \0\n\0:|' > $(@:.o=.d~) && mv -f $(@:.o=.d){~,}

# Link targets.
define LINK
$(1)_host: $(patsubst %.cpp, build/%_host.o, $(patsubst %.c, build/%_host.o, $(SOURCES_$(1)))) $(LIBS_host)
	$(LD_host) -o $$@ $$^ $(OSC_CC_LIBS_INC) -lm $(OSC_CC_LIBS_host) $(OPENCV_LIBS_host)
$(1)_target: $(patsubst %.cpp, build/%_target.o, $(patsubst %.c, build/%_target.o, $(SOURCES_$(1)))) $(LIBS_target)
	$(LD_target) -o $$@ $$^ $(OSC_CC_LIBS_INC) $(OSC_CC_LIBS_target) $(OPENCV_LIBS_target)
endef
$(foreach i, $(PRODUCTS), $(eval $(call LINK,$i)))

.PHONY: $(APP_NAME).app
$(APP_NAME).app: $(addsuffix _target, $(PRODUCTS))
	rm -rf $@
	cp -rL app $@
ifneq "$(wildcard www )" ""
	tar c -h -C www . | gzip > $@/www.tar.gz
endif

# Cleans the module.
clean:
	rm -rf build *.gdb $(BINARIES) $(APP_NAME).app #cgi/cgi_* (FIXME: do not remove to allow make deploy for full target build)
	$(foreach i, $(SUB_PRODUCTS), make -C $i clean)
